<body>

  <div id="y">
     <prompt>üßÅ <cursor id="cursor">_</cursor></prompt>
  </div>

<style>
  #y {
    width: 420px;
    /* height: 600px; */
    position: fixed;
    bottom: 0;
    right: 10%;
    border: 1px solid #ff97df;
    height :350px;
    overflow-y: scroll;
    font-size: 1.2em;
    /* padding: 4pt; */
  }
  /* #y prompt { */
    /* position: fixed; */
    /* width: 500px; */
    /* bottom: 0; */
  /* } */
  body {
    font-size: 16pt;
    margin: 0;
    background: snow;
    /* background: deeppink; */
    color: #befbbc;
    color: #ff97df;
    color: snow;
    color: fuchsia;
    /* direction: rtl; */
    /* unicode-bidi: bidi-override; */
    bottom: 0;
    position: absolute;
    width: 100%;
    font-family: cursive;
  }
  prompt {
    display: block;
    color: snow;
    /* position: fixed; */
    bottom: 0;
    padding: 0 .7em;
    /* margin: 0 -.7em; */
    /* width: 100%; */
    border-top: 1px solid #ff7bf7;
    line-height: 1.6em;
    background: #ff5eed;
    color: #befbbc;
    color: snow;
    /* height: 1.6em; */
    height: min-content;
    /* unicode-bidi: bidi-override; */
    /* margin: 0 -4pt; */
}
  cursor {
    height: 100%;
    display: inline-block;
    animation: blink;
    animation: blink 1s step-start .5s infinite;
  }
  @keyframes blink { 50% { opacity: 0; }}

  em.comment {
    /* color: lilac; */
    color: plum;
  }
</style>

<script type='text/javascript' src="../bubblescript.js"></script>
<script type='text/bubblescript'>

  // Aliases
  muf muff muf
  muf do list
  muf : muf
  muf f: mufn

  muf get-id (fn [a]
    (document.getElementById a))

  muf mufmacro (macro [name args body]
    (list 'muf name
      (list 'macro args body)))

  mufmacro dgi [a],
    (list 'document.getElementById a)
  // blert (+ 7 7 7)

  // blert (tail [1 2 3])

  // muf dgi (macro [a]
  //   (list 'document.getElementById a))

  // blert (dgi "cursor")

  muf cursor (dgi "cursor")

  muf prompt cursor.parentNode
  muf y-el (dgi "y")

  muf br (fn [meow]
    (document.createElement "br"))

  muf print (fn [msg]
    // (window.console.log prompt msg)
    (y-el.insertBefore
      (document.createTextNode msg)
      prompt))

  muf print (fn [msg]
    (print-node (document.createTextNode msg))
    msg)

  muf print-node (fn [node]
    (y-el.insertBefore
      node
      prompt))

  ;muf println (fn [msg]
  ;  (print msg (br)))

  muf println (fn [msg]
    // (window.console.log "Printing" msg)
    // (print (document.createTextNode msg))
    (print msg)
    (print-node (br))
    msg)

  f: lf [], // line feed
    (print-node (br))

  muf typeChar (fn [ch]
    (prompt.insertBefore
      (document.createTextNode ch)
      cursor))

  muf clear (fn [üç¶]
    (export prompt 'innerHTML (+ "üßÅ " üç¶))
    (prompt.append cursor))

  muf backspace (fn [q]
    (prompt.removeChild
      cursor.previousSibling))

  muff read (fn []
    (prompt.innerText.slice 3
      (- prompt.innerText.length 1)))

  // muff üòã (fn [pow]
  //   (let [v (read)]
  //     (if pow
  //       (let [v (new Array (list (pop (parse v))))
  //             r (evl v)]
  //         (println v)
  //         (print " ;> ")
  //         (println r))
  //       (let [r (evl (parse v))]
  //         (println v)
  //         (print " ;> ")
  //         (println r)))
  //     (clear)))

  f: scroll [],
    (export y-el 'scrollTop 10000)

  muff üòã (fn [pow]
    (let [v (read)
          r (evl (parse v))]
      (println v)
      // (print " ;> ")
      // (println r))
      (print-comment (+ "//> " r)))
    (scroll)
    (clear ""))

  f: print-comment [comment],
    (let [node
         (document.createElement "em")]
      (export node 'innerText comment)
      (node.classList.add "comment")
      (print-node node)),
    (lf)

  muf arrow-left (fn []
    (prompt.insertBefore cursor
      cursor.previousSibling))

  muf arrow-right (fn []
    (prompt.insertBefore
      cursor.nextSibling
      cursor))

  // window.avl -> window.addEventListener ucp -> (unique character pattern)
  window.addEventListener 'keydown,
    (jsfn [e]
      (window.console.log e.key)
      (if (= e.key "Backspace")
        (do (e.preventDefault)
            (backspace))
      (if (= e.key "ArrowRight")
        (arrow-right)
      (if (= e.key "ArrowLeft")
        (arrow-left)))))


  window.addEventListener 'keypress,
    (jsfn [e]
      (if (= e.key "Enter")
        (if e.shiftKey
          (wrap-list)
          (üòã))
        (typeChar e.key)))


  mufn set-direction [dir],
    (export document.body 'dir dir),
    (export localStorage 'dir dir)

  mufn get-direction [],
    document.body.dir

  mufn ltr [],
    (set-direction "ltr")

  mufn rtl [],
    (set-direction "rtl")

  mufn trtl [],
    (if (= (get-direction) "rtl")
      (ltr)
      (rtl))

  f: reload [],
    (window.location.reload)

  // Initialize document direction.
  (export document.body 'dir localStorage.dir)

  mufn wrap-list [],
    (clear (+ "(" (read) ")"))

</script>
